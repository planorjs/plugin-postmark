{"version":3,"file":"index.js","sources":["../../../../src/index.js"],"sourcesContent":["import postmark from 'postmark'\nimport {PlanorService} from '@planorjs/core'\n\nexport default class PlanorServicePostmark extends PlanorService {\n  constructor(credentials, opts={}) {\n    super('postmark', 'email')\n\n    this.credentialKeys = ['from', 'token']\n\n    this.setCredentials(credentials)\n    this.setOpts(opts)\n  }\n\n  async getClient() {\n    const creds = super.getCredentials()\n\n    this.client = new postmark.ServerClient(creds.token)\n\n    return this.client\n  }\n\n  async send(mimemsg, msgopts) {\n    const creds = super.getCredentials()\n\n    mimemsg.setSender(creds.from)\n\n    const html = mimemsg.getMessageByType('text/html')\n    const plaintext = mimemsg.getMessageByType('text/plain')\n\n    const postmarkmsg = new postmark.Models.Message()\n    postmarkmsg.From = creds.from\n    postmarkmsg.To = mimemsg.getRecipients({type: 'to'}).map(m => m.addr).join(', ')\n    postmarkmsg.Cc = mimemsg.getRecipients({type: 'cc'}).map(m => m.addr).join(', ')\n    postmarkmsg.Bcc = mimemsg.getRecipients({type: 'bcc'}).map(m => m.addr).join(', ')\n    postmarkmsg.Subject = mimemsg.getSubject()\n    postmarkmsg.HtmlBody = html ? html.data : undefined\n    postmarkmsg.TextBody = plaintext ? plaintext.data : undefined,\n    postmarkmsg.MessageStream = 'outbound'\n    if (msgopts.tag) postmarkmsg.Tag = msgopts.tag\n    if (msgopts.trackOpens) postmarkmsg.TrackOpens = msgopts.trackOpens\n    if (msgopts.trackLinks) postmarkmsg.TrackLinks = msgopts.trackLinks\n    const attachments = mimemsg.getAttachments()\n    if (attachments) {\n      postmarkmsg.Attachments = attachments.map(\n        a => new postmark.Models.Attachment(\n          a.getHeader('Content-Disposition').split('\"')[1],\n          a.data,\n          a.getHeader('Content-Type').split(';')[0]\n        )\n      )\n    }\n\n    const result = await this.client.sendEmail(postmarkmsg)\n\n    if (result.Message == 'OK') {\n      return {\n        id: result.MessageID\n      }\n    }\n\n    throw new Error(`Couldn't send the email`, {cause: result})\n  }\n}\n"],"names":["PlanorServicePostmark","PlanorService","constructor","credentials","opts","credentialKeys","setCredentials","setOpts","getClient","creds","getCredentials","client","postmark","ServerClient","token","send","mimemsg","msgopts","setSender","from","html","getMessageByType","plaintext","postmarkmsg","Models","Message","From","To","getRecipients","type","map","m","addr","join","Cc","Bcc","Subject","getSubject","HtmlBody","data","undefined","TextBody","MessageStream","tag","Tag","trackOpens","TrackOpens","trackLinks","TrackLinks","attachments","getAttachments","Attachments","a","Attachment","getHeader","split","result","sendEmail","id","MessageID","Error","cause"],"mappings":"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"}