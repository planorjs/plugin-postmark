{"version":3,"file":"index.js","sources":["../../src/index.js"],"sourcesContent":["import postmark from 'postmark'\nimport {PlanorService} from '@planorjs/core'\n\nexport default class PlanorServicePostmark extends PlanorService {\n  constructor(credentials, opts={}) {\n    super('postmark', 'email')\n\n    this.credentialKeys = ['from', 'token']\n\n    this.setCredentials(credentials)\n    this.setOpts(opts)\n  }\n\n  async getClient() {\n    const creds = super.getCredentials()\n\n    this.client = new postmark.ServerClient(creds.token)\n\n    return this.client\n  }\n\n  async send(mimemsg, msgopts) {\n    const creds = super.getCredentials()\n\n    mimemsg.setSender(creds.from)\n\n    const html = mimemsg.getMessageByType('text/html')\n    const plaintext = mimemsg.getMessageByType('text/plain')\n\n    const postmarkmsg = new postmark.Models.Message()\n    postmarkmsg.From = creds.from\n    postmarkmsg.To = mimemsg.getRecipients({type: 'to'}).map(m => m.addr).join(', ')\n    postmarkmsg.Cc = mimemsg.getRecipients({type: 'cc'}).map(m => m.addr).join(', ')\n    postmarkmsg.Bcc = mimemsg.getRecipients({type: 'bcc'}).map(m => m.addr).join(', ')\n    postmarkmsg.Subject = mimemsg.getSubject()\n    postmarkmsg.HtmlBody = html ? html.data : undefined\n    postmarkmsg.TextBody = plaintext ? plaintext.data : undefined,\n    postmarkmsg.MessageStream = 'outbound'\n    if (msgopts.tag) postmarkmsg.Tag = msgopts.tag\n    if (msgopts.trackOpens) postmarkmsg.TrackOpens = msgopts.trackOpens\n    if (msgopts.trackLinks) postmarkmsg.TrackLinks = msgopts.trackLinks\n    const attachments = mimemsg.getAttachments()\n    if (attachments) {\n      postmarkmsg.Attachments = attachments.map(\n        a => new postmark.Models.Attachment(\n          a.getHeader('Content-Disposition').split('\"')[1],\n          a.data,\n          a.getHeader('Content-Type').split(';')[0]\n        )\n      )\n    }\n\n    const result = await this.client.sendEmail(postmarkmsg)\n\n    if (result.Message == 'OK') {\n      return {\n        id: result.MessageID\n      }\n    }\n\n    throw new Error(`Couldn't send the email`, {cause: result})\n  }\n}\n"],"names":[],"mappings":";;;AAGe,MAAM,qBAAqB,SAAS,aAAa,CAAC;AACjE,EAAE,WAAW,CAAC,WAAW,EAAE,IAAI,CAAC,EAAE,EAAE;AACpC,IAAI,KAAK,CAAC,UAAU,EAAE,OAAO,EAAC;AAC9B;AACA,IAAI,IAAI,CAAC,cAAc,GAAG,CAAC,MAAM,EAAE,OAAO,EAAC;AAC3C;AACA,IAAI,IAAI,CAAC,cAAc,CAAC,WAAW,EAAC;AACpC,IAAI,IAAI,CAAC,OAAO,CAAC,IAAI,EAAC;AACtB,GAAG;AACH;AACA,EAAE,MAAM,SAAS,GAAG;AACpB,IAAI,MAAM,KAAK,GAAG,KAAK,CAAC,cAAc,GAAE;AACxC;AACA,IAAI,IAAI,CAAC,MAAM,GAAG,IAAI,QAAQ,CAAC,YAAY,CAAC,KAAK,CAAC,KAAK,EAAC;AACxD;AACA,IAAI,OAAO,IAAI,CAAC,MAAM;AACtB,GAAG;AACH;AACA,EAAE,MAAM,IAAI,CAAC,OAAO,EAAE,OAAO,EAAE;AAC/B,IAAI,MAAM,KAAK,GAAG,KAAK,CAAC,cAAc,GAAE;AACxC;AACA,IAAI,OAAO,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,EAAC;AACjC;AACA,IAAI,MAAM,IAAI,GAAG,OAAO,CAAC,gBAAgB,CAAC,WAAW,EAAC;AACtD,IAAI,MAAM,SAAS,GAAG,OAAO,CAAC,gBAAgB,CAAC,YAAY,EAAC;AAC5D;AACA,IAAI,MAAM,WAAW,GAAG,IAAI,QAAQ,CAAC,MAAM,CAAC,OAAO,GAAE;AACrD,IAAI,WAAW,CAAC,IAAI,GAAG,KAAK,CAAC,KAAI;AACjC,IAAI,WAAW,CAAC,EAAE,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,EAAC;AACpF,IAAI,WAAW,CAAC,EAAE,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,EAAC;AACpF,IAAI,WAAW,CAAC,GAAG,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,IAAI,EAAC;AACtF,IAAI,WAAW,CAAC,OAAO,GAAG,OAAO,CAAC,UAAU,GAAE;AAC9C,IAAI,WAAW,CAAC,QAAQ,GAAG,IAAI,GAAG,IAAI,CAAC,IAAI,GAAG,UAAS;AACvD,IAAI,WAAW,CAAC,QAAQ,GAAG,SAAS,GAAG,SAAS,CAAC,IAAI,GAAG,SAAS;AACjE,IAAI,WAAW,CAAC,aAAa,GAAG,WAAU;AAC1C,IAAI,IAAI,OAAO,CAAC,GAAG,EAAE,WAAW,CAAC,GAAG,GAAG,OAAO,CAAC,IAAG;AAClD,IAAI,IAAI,OAAO,CAAC,UAAU,EAAE,WAAW,CAAC,UAAU,GAAG,OAAO,CAAC,WAAU;AACvE,IAAI,IAAI,OAAO,CAAC,UAAU,EAAE,WAAW,CAAC,UAAU,GAAG,OAAO,CAAC,WAAU;AACvE,IAAI,MAAM,WAAW,GAAG,OAAO,CAAC,cAAc,GAAE;AAChD,IAAI,IAAI,WAAW,EAAE;AACrB,MAAM,WAAW,CAAC,WAAW,GAAG,WAAW,CAAC,GAAG;AAC/C,QAAQ,CAAC,IAAI,IAAI,QAAQ,CAAC,MAAM,CAAC,UAAU;AAC3C,UAAU,CAAC,CAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AAC1D,UAAU,CAAC,CAAC,IAAI;AAChB,UAAU,CAAC,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;AACnD,SAAS;AACT,QAAO;AACP,KAAK;AACL;AACA,IAAI,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,WAAW,EAAC;AAC3D;AACA,IAAI,IAAI,MAAM,CAAC,OAAO,IAAI,IAAI,EAAE;AAChC,MAAM,OAAO;AACb,QAAQ,EAAE,EAAE,MAAM,CAAC,SAAS;AAC5B,OAAO;AACP,KAAK;AACL;AACA,IAAI,MAAM,IAAI,KAAK,CAAC,CAAC,uBAAuB,CAAC,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;AAC/D,GAAG;AACH;;;;"}